{% load static %}
{% load custom_filters %}

<!DOCTYPE html>
<html lang="en">
    <head>
    <!---->
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="{% static 'mine/stylescss.css'  %}" >
        <link rel="stylesheet" href="{% static 'lib/bootstrap/dist/css/bootstrap.css' %}" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/font-awesome.min.css">
        <link rel=icon href="{% static 'img/favicon-datamite.png' %}">
        <link rel="stylesheet" href="{% static 'fontawesome/css/all.css'  %}" >
        <link rel="stylesheet" href="{% static 'css/site.css' %}" />
        <meta name='viewport' content='width=device-width, initial-scale=1'>
        <script href='https://kit.fontawesome.com/a076d05399.js' crossorigin='anonymous'></script>
        <!--name x is the id to hide, name 2 is the value of the buttion yes,no,etc to hide-->
    </head>

    <body>


        <header>
            {% include "Shared/_Navbar.html" %}
            {% block header %}
            {% endblock %}
        </header>

        <div class="container">
            <script>
                (function () {
                    var button = document.querySelector("#cookieConsent button[data-cookie-string]");
                    button.addEventListener("click", function (event) {
                        document.cookie = button.dataset.cookieString;
                    }, false);
                })();
            </script>

            {% block main1 %}
            {% endblock %}

            <main role="main"> <!-- here was placed class="pb-3"-->

            {% block main2 %}
            {% endblock %}

            </main>

            {% block main3 %}
            {% endblock %}

        </div>


        <footer class="border-top footer text-muted">
            <div class="container">
                {% include "Shared/_footer.html" %}
                   {% block footer %}{% endblock %}
            </div>

            {% block footer2 %}
            {% endblock %}

        </footer>

        <script src="{% static 'lib/jquery/dist/jquery.min.js' %}"></script>
        <script src="https://ajax.aspnetcdn.com/ajax/jquery.unobtrusive-ajax/3.2.5/jquery.unobtrusive-ajax.min.js"></script>
        <script src="{% static '/lib/bootstrap/dist/js/bootstrap.bundle.min.js' %}"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
        <script src="https://use.fontawesome.com/1bbdefb14c.js"></script>
        <script src="{% static 'js/checkbox-row-toggle.js' %}"></script>
        <script src="{% static 'js/radio-row-select.js' %}"></script>
        <script src="{% static 'js/validate_preferences.js'%}"></script>

         <!-- Chatbot JavaScript -->
         <script>
            function openChatbot() {
                // Create modal for chatbot
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    z-index: 10000;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                `;
                
                // Create close button
                const closeBtn = document.createElement('button');
                closeBtn.innerHTML = '&times;';
                closeBtn.style.cssText = `
                    position: absolute;
                    top: 10px;
                    right: 15px;
                    background: none;
                    border: none;
                    color: white;
                    font-size: 30px;
                    cursor: pointer;
                    z-index: 10002;
                `;
                closeBtn.onclick = () => {
                    document.body.removeChild(modal);
                    document.body.removeChild(closeBtn);
                };
                
                // Create iframe for Gradio widget
                const iframe = document.createElement('iframe');
                // Chatbot URL - update this for production deployment
                const chatbotUrl = "http://localhost:7860"; // Change to your production URL when deployed
                iframe.src = chatbotUrl;
                iframe.style.cssText = `
                    width: 90%;
                    height: 80%;
                    border: none;
                    border-radius: 10px;
                    background: white;
                `;
                
                modal.appendChild(iframe);
                document.body.appendChild(modal);
                document.body.appendChild(closeBtn);
                
                // Close modal when clicking outside
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                        document.body.removeChild(closeBtn);
                    }
                };
            }
            </script>
        {% block last %}
        {% endblock %}

    <!-- Global Floating Action Button -->
    <div class="fab-container" style="position: fixed; bottom: 24px; right: 24px; z-index: 1030;">
        <button type="button" class="btn btn-primary btn-lg rounded-circle shadow dm-fab"
                style="width:56px;height:56px;display:flex;align-items:center;justify-content:center;"
                data-bs-toggle="modal" data-bs-target="#chatModal" aria-label="Open Chat">
        <i class="fa fa-comment"></i>
        </button>
    </div>
    
    <!-- Global Chat Modal -->
    <div class="modal fade" id="chatModal" tabindex="-1" aria-labelledby="chatModalLabel"
        aria-hidden="true" data-bs-backdrop="false" data-bs-keyboard="false">
    <div class="modal-dialog modal-sm"
        style="position: fixed; bottom: 24px; right: 24px; left:auto; margin:0; max-width: 380px; width: 100%;">
        <div class="modal-content" style="border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.3); height: 70vh;">
        {% include "chat.html" %}
        </div>
    </div>
    </div>


        <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, checking Bootstrap...');
            
            // Check if Bootstrap is loaded
            if (typeof bootstrap === 'undefined') {
                console.error('Bootstrap is not loaded!');
                return;
            }
            
            console.log('Bootstrap is loaded');
            
            // Add click event listener as backup
            const chatButton = document.querySelector('[data-bs-target="#chatModal"]');
            if (chatButton) {
                chatButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Chat button clicked');
                    const modal = new bootstrap.Modal(document.getElementById('chatModal'), {
                        backdrop: false,
                        keyboard: false
                    });
                    
                    // Prevent Bootstrap from modifying body styles
                    modal._config.backdrop = false;
                    modal._config.keyboard = false;
                    
                    modal.show();
                    
                    // Immediately remove any body classes that Bootstrap might add
                    setTimeout(() => {
                        document.body.classList.remove('modal-open');
                        document.body.style.overflow = '';
                        document.body.style.paddingRight = '';
                        
                        // Force remove any Bootstrap modal styles
                        document.body.style.position = '';
                        document.body.style.top = '';
                        document.body.style.left = '';
                        document.body.style.width = '';
                    }, 0);
                    
                    // Also prevent Bootstrap from adding styles during the modal lifecycle
                    const originalSetStyle = modal._setEscapeEvent;
                    modal._setEscapeEvent = function() {};
                });
            } else {
                console.error('Chat button not found');
            }
            
            // Ensure close button works
            const modal = document.getElementById('chatModal');
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    const bootstrapModal = bootstrap.Modal.getInstance(modal);
                    if (bootstrapModal) {
                        bootstrapModal.hide();
                    }
                }
            });
        });
        </script>

    </body>
</html>