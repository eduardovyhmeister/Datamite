{% extends "Shared/_layout.html" %}
{% load static %}
{% load custom_filters %}

{%block head%}
    <title> DATAMITE - ANP-AHP - Interfamily Relationships </title>
{%endblock%}

{% block navbar %}{% endblock%}
{% block main1%}{%endblock%}


{%block main2%}
{{ kpi_lists|json_script:"kpi-dependency-data" }}

<div class="row">
{% include "Shared/_survey.html" %}
<div class="col-md-9">
    <div id="surveyContainer">

        <div class="panel-heading card-header">
            <div class="sv_header__text">
                <h3><span style="position: static;"> Step 3 - Interfamily relationships: </span></h3>
            </div>
            <p style="text-align: justify;">
                So far, you have selected KPIs/metrics that you would like to include in your ANP-AHP evaluation and set the preferences between these KPIs/metrics. However, some metrics might influence others. In this section, you can select KPIs/metrics and assign to them other KPIs/metrics that will influence their weighthing in the overall analysis.
            </p>
            <p style="text-align: justify;">
                The weighting of KPIs/metrics within the same BSC family has been done when you set the preferences for KPIs/metrics. Now, you can set interfamily relationships and the preferences will be set in the next step.
            </p>
        </div>
        </br>

        <form method='POST' id="kpiForm">
            {% csrf_token %}
            <div style="display: inline-block; width:100%;">
                <p  style="text-align: justify;">
                    1) Select a KPI/metric that you think will depend on other KPIs/metrics from another BSC family. 
                </p>
                <p  style="text-align: justify;">
                    2) Select the KPIs/metrics that will influence the selected KPI/metric (use control + click to select multiple ones). 
                </p>
                <p  style="text-align: justify;">
                    3) Click "Add another relationship" to add another KPI/metric selection.<br/>
                </p>
                <p  style="text-align: justify;">
                    4) You can delete any relationship you have created using the delete button of that relationship. (Use this to also leave the whole step empty if you think you do not need interfamily relationships.)<br/>
                </p>
            </div>
            
            {{ formset.management_form }}

            <div id="formset-container">
                {% for form in formset %}
                    <div class="form-wrapper">
                        <div class="kpi-form">
                            <div class="row">
                                <div class="col-md-6 form-group">
                                    <label for="{{ form.main_kpi.id_for_label }}">{{ form.main_kpi.label }}</label>
                                    {{ form.main_kpi }}
                                    <button type="button" class="btn btn-sm btn-danger mt-2 delete-form">Delete this relationship</button>
                                </div>
                                <div class="col-md-6 form-group dependency-container" style="display: none;">
                                    <label>{{ form.dependencies.label }}</label>
                                    <select name="{{ form.dependencies.name }}" multiple class="form-control" size="6"></select>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

            {% comment %} {% if ANPAHP.current_step > 6 %}
                <div class="alert alert-warning">
                    <p  style="text-align: justify;">
                        ⚠️ Changing your selection of KPIs/metrics here and confirming these changes will reset the next step (KPIs/metrics preferences).
                    </p>
                </div>
            {% endif %} {% endcomment %}

            <button type="button" id="add-form" class="btn btn-outline-primary">Add another relationship</button>
            <button type="submit" class="btn btn-primary card-btn" name="action" value="confirm"> Confirm selection </button>
        </form>
    </div>
</div>


<script>
document.getElementById("formset-container").addEventListener("click", function (event) {
    if (event.target.classList.contains("delete-form")) {
        const wrapper = event.target.closest(".form-wrapper");
        wrapper.remove();
        reindexForms(); // ✅ safe and preserves input values
    }

    function reindexForms() {
        const forms = document.querySelectorAll(".form-wrapper");
        const totalForms = document.getElementById("id_form-TOTAL_FORMS");
        totalForms.value = forms.length;

        forms.forEach((wrapperEl, index) => {
            wrapperEl.querySelectorAll("input, select, label").forEach(el => {
                // Update `name`
                if (el.name) {
                    el.name = el.name.replace(/form-\d+/, `form-${index}`);
                }

                // Update `id`
                if (el.id) {
                    el.id = el.id.replace(/form-\d+/, `form-${index}`);
                }

                // Update `for` (label tag)
                if (el.htmlFor) {
                    el.htmlFor = el.htmlFor.replace(/form-\d+/, `form-${index}`);
                }
            });
        });
    }
});

let blankFormHTML;

document.addEventListener("DOMContentLoaded", function () {
    const firstWrapper = document.querySelector(".form-wrapper");
    blankFormHTML = firstWrapper.outerHTML;
    
    const kpiMap = JSON.parse(document.getElementById("kpi-dependency-data").textContent);
    const formsetContainer = document.getElementById("formset-container");
    const addButton = document.getElementById("add-form");
    const totalForms = document.getElementById("id_form-TOTAL_FORMS");

    // Hook up dynamic form cloning
    addButton.addEventListener("click", function () {
        const formCount = parseInt(totalForms.value);

        // Clone the clean backup form
        const wrapper = document.createElement("div");
        wrapper.className = "form-wrapper";
        wrapper.innerHTML = blankFormHTML.replace(/form-\d+/g, `form-${formCount}`);

        // Reset fields
        const select = wrapper.querySelector("select[name$='main_kpi']");
        if (select) select.selectedIndex = 0;

        const depContainer = wrapper.querySelector(".dependency-container");
        const depSelect = wrapper.querySelector("select[multiple]");
        depSelect.innerHTML = "";
        depContainer.style.display = "none";

        formsetContainer.appendChild(wrapper);
        totalForms.value = formCount + 1;
    });

    // Dynamic population logic for dependencies (delegated binding)
    formsetContainer.addEventListener("change", function (event) {
        if (event.target.matches("select[name$='main_kpi']")) {
            const mainKPI = event.target;
            const selectedText = mainKPI.options[mainKPI.selectedIndex].text;
            const formDiv = mainKPI.closest(".kpi-form");
            const dependenciesBox = formDiv.querySelector("select[multiple]");
            const container = formDiv.querySelector(".dependency-container");

            dependenciesBox.innerHTML = "";
            const deps = kpiMap[selectedText] || [];
            deps.forEach(name => {
                const opt = document.createElement("option");
                opt.value = name;
                opt.textContent = name;
                dependenciesBox.appendChild(opt);
            });

            container.style.display = deps.length > 0 ? "block" : "none";
        }
    });
});
</script>
{% endblock %}


{% block footer%}{%endblock%}
{%block lastk%}{% endblock %}