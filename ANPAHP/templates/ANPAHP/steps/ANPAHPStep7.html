{% extends "Shared/_layout.html" %}
{% load static %}
{% load custom_filters %}

{%block head%}
    <title> DATAMITE - ANP-AHP - Interfamily Relationships </title>
{%endblock%}

{% block navbar %}{% endblock%}
{% block main1%}{%endblock%}


{%block main2%}
{{ kpi_lists|json_script:"kpi-dependency-data" }}
{{ ANPAHP.intermetric_relationships|json_script:"initial-selection-data" }}

<div class="row">
{% include "Shared/_survey.html" %}
<div class="col-md-9">
    <div id="surveyContainer">

        <div class="panel-heading card-header">
            <div class="sv_header__text">
                <h3><span style="position: static;"> Step 7 - Interfamily relationships: </span></h3>
            </div>
            <p style="text-align: justify;">
                So far, you have selected KPIs/metrics that you would like to include in your ANP-AHP evaluation and set the preferences between these KPIs/metrics to compute the value of each BSC family. However, some KPIs/metrics may not be measured directly but computed from others. In this step, you specify which KPIs/metrics depend on which other KPIs/metrics.
            </p>
            <p style="text-align: justify;">
                In the next step, you will setup the importance of each of these dependencies.
            </p>
        </div>
        </br>

        <form method='POST' id="kpiForm">
            {% csrf_token %}
            <div style="display: inline-block; width:100%;">
                <p  style="text-align: justify;">
                    1) Select a KPI/metric that you think will depend on other KPIs/metrics. 
                </p>
                <p  style="text-align: justify;">
                    2) Select the KPIs/metrics that will influence the selected KPI/metric (use control + click to select multiple ones). 
                </p>
                <p  style="text-align: justify;">
                    3) Click "Add another relationship" to add another KPI/metric selection.<br/>
                </p>
                <p  style="text-align: justify;">
                    4) You can delete any relationship you have created using the delete button of that relationship.<br/>
                </p>
                <p  style="text-align: justify;">
                    If you think you do not need intermetric relationships, you can just confirm to save that no relationships exist. Also, any incomplete kpi-dependencies subform will not be taken into account when confirming (it won't create any issue).
                </p>
            </div>
            
            {{ formset.management_form }}

            <div id="formset-container">
                {% for form in formset %}
                    <div class="form-wrapper">
                        <div class="kpi-form">
                            <div class="row">
                                <div class="col-md-6 form-group">
                                    <label for="{{ form.main_kpi.id_for_label }}">{{ form.main_kpi.label }}</label>
                                    {{ form.main_kpi }}
                                    <button type="button" class="btn btn-sm btn-danger mt-2 delete-form">Delete this relationship</button>
                                </div>
                                <div class="col-md-6 form-group dependency-container" style="display: none;">
                                    <label>{{ form.dependencies.label }}</label>
                                    <select name="{{ form.prefix }}-dependencies" multiple class="form-control" size="6"></select>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

            {% if ANPAHP.current_step > 7 %}
                <div class="alert alert-warning">
                    <p  style="text-align: justify;">
                        ⚠️ Changing your selection of KPIs/metrics here and confirming these changes will reset the next step (KPIs/metrics importance).
                    </p>
                </div>
            {% endif %}

            <button type="button" id="add-form" class="btn btn-outline-primary">Add another relationship</button>
            <button type="submit" class="btn btn-primary card-btn" name="action" value="confirm"> Confirm selection </button>
        </form>
    </div>
</div>


<script>
// Function for managing indices correctly and keeping the selections when deleting a form:
document.getElementById("formset-container").addEventListener("click", function (event) {
    if (event.target.classList.contains("delete-form")) {
        const wrapper = event.target.closest(".form-wrapper");
        wrapper.remove();
        reindexForms(); // safe and preserves input values
    }

    // Reindex forms when one is deleted, to keep the django naming conventions
    // of formset consistent:
    function reindexForms() {
        const forms = document.querySelectorAll(".form-wrapper");
        const totalForms = document.getElementById("id_form-TOTAL_FORMS");
        totalForms.value = forms.length;

        forms.forEach((wrapperEl, index) => {
            wrapperEl.querySelectorAll("input, select, label").forEach(el => {
                if (el.name) { // Update `name`
                    el.name = el.name.replace(/form-\d+/, `form-${index}`);
                }
                if (el.id) { // Update `id`
                    el.id = el.id.replace(/form-\d+/, `form-${index}`);
                }
                if (el.htmlFor) { // Update `for` (label tag)
                    el.htmlFor = el.htmlFor.replace(/form-\d+/, `form-${index}`);
                }
            });
        });
    }
});

// Used as a template empty form when all forms are deleted:
let blankFormHTML;

// Manages the dynamic part of the page, with the selection appearing only
// when a main_kpi is selected and adding new forms when the add new relationship
// button is clicked.
document.addEventListener("DOMContentLoaded", function () {
    const firstWrapper = document.querySelector(".form-wrapper");
    // Ensure that if there are no initial forms, a blank one is created to get the HTML
    if (firstWrapper) {
        blankFormHTML = firstWrapper.outerHTML;
    } else {
        // Fallback for when there are no initial forms (e.g., first time visiting)  
        blankFormHTML = `
            <div class="form-wrapper">
                <div class="kpi-form">
                    <div class="row">
                        <div class="col-md-6 form-group">
                            <label>Main KPI</label>
                            <select name="form-__prefix__-main_kpi" class="form-control"></select>
                            <button type="button" class="btn btn-sm btn-danger mt-2 delete-form">Delete this relationship</button>
                        </div>
                        <div class="col-md-6 form-group dependency-container" style="display: none;">
                            <label>Dependencies</label>
                            <select name="form-__prefix__-dependencies" multiple class="form-control" size="6"></select>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    const kpiMap = JSON.parse(document.getElementById("kpi-dependency-data").textContent);
    const initialSavedRelationships = JSON.parse(document.getElementById("initial-selection-data").textContent);

    const formsetContainer = document.getElementById("formset-container");
    const addButton = document.getElementById("add-form");
    const totalForms = document.getElementById("id_form-TOTAL_FORMS");

    // Function to populate dependencies based on main KPI selection.
    // mainKPISelect: the KPI selected (main_kpi)
    // preSelectedDeps: the selected options (passed only for already saved data, [] otherwise)
    function populateDependencies(mainKPISelect, preSelectedDeps = []) {
        const selectedText = mainKPISelect.options[mainKPISelect.selectedIndex].text;
        const formDiv = mainKPISelect.closest(".kpi-form");
        const dependenciesBox = formDiv.querySelector("select[name$='dependencies']");
        const container = formDiv.querySelector(".dependency-container");

        dependenciesBox.innerHTML = ""; // Clear existing options

        const deps = kpiMap[selectedText] || []; // Get possible dependencies from kpiMap
        deps.forEach(name => {
            const opt = document.createElement("option");
            opt.value = name;
            opt.textContent = name;
            if (preSelectedDeps.includes(name)) { // Select the preselected options
                opt.selected = true;
            }
            dependenciesBox.appendChild(opt);
        });

        // Only display if there are actual potential dependencies
        container.style.display = deps.length > 0 ? "block" : "none";
    }


    // Add form logic
    addButton.addEventListener("click", function () {
        const formCount = parseInt(totalForms.value);
        const wrapper = document.createElement("div");
        wrapper.className = "form-wrapper";
        // Ensure prefix replacement for new forms
        wrapper.innerHTML = blankFormHTML.replace(/form-(__prefix__|\d+)/g, `form-${formCount}`);

        const mainKpiSelect = wrapper.querySelector("select[name$='main_kpi']");
        if (mainKpiSelect) mainKpiSelect.selectedIndex = 0; // Reset to default/first option

        // Clear and hide dependencies for new forms (they start blank)
        const depContainer = wrapper.querySelector(".dependency-container");
        const depSelect = wrapper.querySelector("select[multiple]");
        if (depSelect) depSelect.innerHTML = "";
        if (depContainer) depContainer.style.display = "none";

        formsetContainer.appendChild(wrapper);
        totalForms.value = formCount + 1;
    });

    // Delegate dynamic change logic for main KPI selection
    formsetContainer.addEventListener("change", function (event) {
        if (event.target.matches("select[name$='main_kpi']")) {
            populateDependencies(event.target, []); // Pass an empty array for new selections
        }
    });

    // Initialisation for pre-populated form entries (on page load)
    document.querySelectorAll(".form-wrapper").forEach((formWrapper, index) => {
        const mainKPISelect = formWrapper.querySelector("select[name$='main_kpi']");
        if (mainKPISelect) {
            const initialMainKpiText = mainKPISelect.options[mainKPISelect.selectedIndex]?.text;
            const savedDependenciesForThisForm = initialSavedRelationships[initialMainKpiText] || [];
            populateDependencies(mainKPISelect, savedDependenciesForThisForm);
        }
    });
});
</script>
{% endblock %}


{% block footer%}{%endblock%}
{%block lastk%}{% endblock %}