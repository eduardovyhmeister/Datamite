<div class="modal-header">
    <h6 class="modal-title" id="chatModalLabel">AI Assistant</h6>
    <button type="button" id="closeChatModal" aria-label="Close" style="background: none; border: none; font-size: 1.5rem; color: #6c757d; opacity: 0.8; cursor: pointer; padding: 0; margin: 0;">&times;</button>
  </div>
  
  <div class="modal-body d-flex flex-column p-0" style="height: 75vh;">
    <!-- AI Logic Header -->
    <div class="p-2 pb-1">
      <h6 class="mb-0 text-muted" style="cursor: pointer;" onclick="toggleAILogic()">
        AI Logic 
        <i id="aiLogicToggle" class="fa fa-chevron-down ms-2" style="font-size: 0.8rem;"></i>
      </h6>
    </div>
    
    <!-- AI Logic Accordion Section -->
    <div id="aiLogicAccordion" class="collapse" style="transition: all 0.3s ease;">
      <div class="p-2 pt-0">
        <div id="logicPanel"
             class="small p-2 bg-light rounded"
             style="max-height: 20vh; overflow-y:auto; white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;">
          (AI Logic appears here)
        </div>
      </div>
    </div>
    
    <!-- Separator Line -->
    <hr class="my-2">
  
    <!-- Chat Section -->
    <div class="d-flex flex-column flex-grow-1">
      <!-- Chat Header -->
      <div class="p-2 pb-1">
        <h6 class="mb-0 text-muted">Chat</h6>
      </div>
      <!-- Messages -->
      <div id="chatBox" class="flex-grow-1 p-3 bg-light" style="height: 0; min-height: 0; overflow-y: auto;">
        <div class="msg bot">Ask me about data monetization, ANP-AHP methodology, or how to use our evaluation tool!</div>
        
        <!-- Example Questions -->
        <div id="exampleHeader" class="mt-3 mb-1 small text-muted">Example questions</div>
        <div class="example-questions mt-1">
            {% for question in example_questions %}
            <div class="example-question" data-question="{{ question }}">{{ question }}</div>
            {% endfor %}    
        </div>
      </div>
  
      <!-- Input -->
      <div class="p-2 border-top">
        <div class="input-group">
          <input id="userInput" type="text" class="form-control" placeholder="Type your message…" maxlength="500">
          <button id="sendBtn" class="btn btn-primary" type="button">Send</button>
        </div>
      </div>
    </div>
  </div>
  
  <style>
    /* Message bubbles */
    .msg {
      max-width: 80%;
      padding: 8px 10px;
      margin: 4px 0;
      border-radius: 10px;
      line-height: 1.3;
      font-size: 0.9rem;
    }
    .msg.user {
      margin-left: auto;
      background: #d9ecff;
    }
    .msg.bot {
      margin-right: auto;
      background: #fff;
      border: 1px solid #ddd;
    }
    
    /* Example questions styling */
    .example-questions {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .example-question {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }
    
    .example-question:hover {
      background: #e9ecef;
      border-color: #007bff;
    }
    
    /* Custom scrollbar for chat and logic panel */
    #chatBox::-webkit-scrollbar,
    #logicPanel::-webkit-scrollbar {
      width: 6px;
    }
    
    #chatBox::-webkit-scrollbar-track,
    #logicPanel::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }
    
    #chatBox::-webkit-scrollbar-thumb,
    #logicPanel::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 3px;
    }
    
    #chatBox::-webkit-scrollbar-thumb:hover,
    #logicPanel::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
  </style>
  
  <script>
    // Global function for toggling AI Logic accordion
    function toggleAILogic() {
      const accordion = document.getElementById('aiLogicAccordion');
      const toggleIcon = document.getElementById('aiLogicToggle');
      
      if (accordion.classList.contains('show')) {
        // Collapse
        accordion.classList.remove('show');
        toggleIcon.classList.remove('fa-chevron-up');
        toggleIcon.classList.add('fa-chevron-down');
      } else {
        // Expand
        accordion.classList.add('show');
        toggleIcon.classList.remove('fa-chevron-down');
        toggleIcon.classList.add('fa-chevron-up');
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      const endpointUrl = "{% url 'chat_ask' %}";
      const messageInput = document.getElementById('userInput');
      const sendButton = document.getElementById('sendBtn');
      const chatBox = document.getElementById('chatBox');
      const closeButton = document.getElementById('closeChatModal');
      const exampleQuestions = document.querySelectorAll('.example-question');
      
      // Close button functionality
      if (closeButton) {
        closeButton.addEventListener('click', function() {
          console.log('Close button clicked');
          const modalElement = document.getElementById('chatModal');
          if (modalElement) {
            modalElement.classList.remove('show');
            modalElement.classList.add('hide');
            modalElement.style.display = 'none';
            
            // Ensure body styles are reset
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            
            // Remove any backdrop
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) {
              backdrop.remove();
            }
          }
        });
      }
      
      // Example questions functionality
      exampleQuestions.forEach(question => {
        question.addEventListener('click', function() {
          const questionText = this.getAttribute('data-question');
          addMessage(questionText, true);
          hideExamples();
        });
      });
      
      function addMessage(content, isUser = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `msg ${isUser ? 'user' : 'bot'}`;
        
        const now = new Date();
        const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        messageDiv.innerHTML = `
          <div>${content}</div>
          <small style="opacity: 0.7; font-size: 0.75rem;">${timeString}</small>
        `;
        
        chatBox.appendChild(messageDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
        
        // Hide example questions after first user message
        if (isUser) {
          hideExamples();
        }
        
        // If this is a user message, send to backend and show AI response
        if (isUser) {
          sendToBackend(content);
        }
      }
      
      function sendMessage() {
        const message = messageInput.value.trim();
        if (message) {
          addMessage(message, true);
          messageInput.value = '';
        }
      }
      
      sendButton.addEventListener('click', sendMessage);
      
      messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });

      function hideExamples() {
        const exampleContainer = document.querySelector('.example-questions');
        const exampleHeader = document.getElementById('exampleHeader');
        if (exampleContainer) exampleContainer.style.display = 'none';
        if (exampleHeader) exampleHeader.style.display = 'none';
      }

      async function sendToBackend(message) {
        // typing indicator
        const typingDiv = document.createElement('div');
        typingDiv.className = 'msg bot';
        typingDiv.textContent = 'Thinking…';
        chatBox.appendChild(typingDiv);
        chatBox.scrollTop = chatBox.scrollHeight;

        try {
          const res = await fetch(endpointUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ message })
          });

          typingDiv.remove();

          const data = await res.json();
          if (!res.ok) {
            addMessage(data.error || 'Error from server', false);
            return;
          }

          if (data.logic) {
            const logicPanel = document.getElementById('logicPanel');
            if (logicPanel) {
              // Render line-by-line
              const toText = (value) => {
                if (typeof value === 'string') return value;
                try { return JSON.stringify(value, null, 2); } catch { return String(value); }
              };
              const lines = toText(data.logic).split('\n').filter(l => l.trim().length > 0);
              logicPanel.innerHTML = '';
              const list = document.createElement('ol');
              list.style.margin = '0';
              list.style.paddingLeft = '1.2rem';
              lines.forEach((line) => {
                const li = document.createElement('li');
                li.textContent = line;
                list.appendChild(li);
              });
              logicPanel.appendChild(list);
              logicPanel.scrollTop = logicPanel.scrollHeight;
            }
          }

          addMessage(data.response || 'No response', false);
        } catch (e) {
          typingDiv.remove();
          addMessage('Network error. Please try again.', false);
        }
      }
    });
  </script>